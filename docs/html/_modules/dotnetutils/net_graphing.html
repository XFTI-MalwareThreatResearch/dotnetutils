<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dotnetutils.net_graphing &#8212; dotnetutils  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for dotnetutils.net_graphing</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dotnetutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">net_cil_disas</span><span class="p">,</span> <span class="n">net_emulator</span><span class="p">,</span> <span class="n">net_structs</span><span class="p">,</span> <span class="n">net_opcodes</span><span class="p">,</span> <span class="n">net_row_objects</span><span class="p">,</span> <span class="n">net_exceptions</span>

<div class="viewcode-block" id="FunctionBlock">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FunctionBlock</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_object</span><span class="p">,</span> <span class="n">disasm_object</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__method_object</span> <span class="o">=</span> <span class="n">method_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__disasm_object</span> <span class="o">=</span> <span class="n">disasm_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__instrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__previous</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__next</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__start_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__original_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__was_cleared</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__original_cleared</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__original_nexts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__graph_id</span> <span class="o">=</span> <span class="n">graph_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_junk_block</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_switch_case</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__was_switch_block</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_finished</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_try</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_catch</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_finally</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__try_block_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__catch_block_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__finally_block_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<div class="viewcode-block" id="FunctionBlock.set_try_block_offset">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.set_try_block_offset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_try_block_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__try_block_offset</span> <span class="o">=</span> <span class="n">offset</span></div>


<div class="viewcode-block" id="FunctionBlock.set_catch_block_offset">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.set_catch_block_offset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_catch_block_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__catch_block_offset</span> <span class="o">=</span> <span class="n">offset</span></div>


<div class="viewcode-block" id="FunctionBlock.set_finally_block_offset">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.set_finally_block_offset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_finally_block_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__finally_block_offset</span> <span class="o">=</span> <span class="n">offset</span></div>


<div class="viewcode-block" id="FunctionBlock.get_try_block_offset">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_try_block_offset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_try_block_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__try_block_offset</span></div>

    
<div class="viewcode-block" id="FunctionBlock.get_catch_block_offset">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_catch_block_offset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_catch_block_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__catch_block_offset</span></div>

    
<div class="viewcode-block" id="FunctionBlock.get_finally_block_offset">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_finally_block_offset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_finally_block_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__finally_block_offset</span></div>


<div class="viewcode-block" id="FunctionBlock.mark_block_try">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.mark_block_try">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mark_block_try</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_try</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FunctionBlock.mark_block_catch">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.mark_block_catch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mark_block_catch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_catch</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FunctionBlock.mark_block_finally">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.mark_block_finally">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mark_block_finally</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_finally</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FunctionBlock.is_block_try">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.is_block_try">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_block_try</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_try</span></div>

    
<div class="viewcode-block" id="FunctionBlock.is_block_catch">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.is_block_catch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_block_catch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_catch</span></div>

    
<div class="viewcode-block" id="FunctionBlock.is_block_finally">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.is_block_finally">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_block_finally</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_finally</span></div>


<div class="viewcode-block" id="FunctionBlock.mark_block_finished">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.mark_block_finished">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mark_block_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_finished</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FunctionBlock.mark_switch_block">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.mark_switch_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mark_switch_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__was_switch_block</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FunctionBlock.was_switch_block">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.was_switch_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">was_switch_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__was_switch_block</span></div>


<div class="viewcode-block" id="FunctionBlock.is_block_return">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.is_block_return">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_block_return</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ret&#39;</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__start_offset</span><span class="p">)</span>

<div class="viewcode-block" id="FunctionBlock.get_current_size">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_current_size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="FunctionBlock.mark_switch_case">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.mark_switch_case">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mark_switch_case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_switch_case</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FunctionBlock.is_switch_case">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.is_switch_case">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_switch_case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_switch_case</span></div>

    
<div class="viewcode-block" id="FunctionBlock.get_instr_index">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_instr_index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_instr_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instr</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">())):</span>
            <span class="n">pt_instr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="n">x</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pt_instr</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">instr</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>

    
<div class="viewcode-block" id="FunctionBlock.mark_junk">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.mark_junk">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mark_junk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_junk_block</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FunctionBlock.is_junk_block">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.is_junk_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_junk_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_junk_block</span></div>

    
<div class="viewcode-block" id="FunctionBlock.reverse_next">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.reverse_next">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reverse_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__next</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span></div>


<div class="viewcode-block" id="FunctionBlock.is_start">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.is_start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__start_offset</span> <span class="o">==</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="FunctionBlock.get_original_length">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_original_length">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_original_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__original_length</span></div>


<div class="viewcode-block" id="FunctionBlock.has_absolute_path_to_zero">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.has_absolute_path_to_zero">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_absolute_path_to_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__start_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prev</span>
        <span class="k">for</span> <span class="n">prev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prev</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">prev</span><span class="o">.</span><span class="n">has_absolute_path_to_zero</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="FunctionBlock.block_leads_switch">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.block_leads_switch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">block_leads_switch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_block_switch</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_block_absolutejmp</span><span class="p">():</span>
            <span class="n">usable</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">usable</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">usable</span><span class="o">.</span><span class="n">is_block_absolutejmp</span><span class="p">():</span>
                <span class="n">usable</span> <span class="o">=</span> <span class="n">usable</span><span class="o">.</span><span class="n">ge_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">usable</span><span class="o">.</span><span class="n">is_block_switch</span><span class="p">():</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="FunctionBlock.get_instr_at_index">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_instr_at_index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_instr_at_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__instrs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></div>


<div class="viewcode-block" id="FunctionBlock.replace_instr">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.replace_instr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace_instr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">new_instr</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__instrs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__instrs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">new_instr</span><span class="p">)</span></div>


<div class="viewcode-block" id="FunctionBlock.insert_instr">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.insert_instr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">insert_instr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">instr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__instrs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">instr</span><span class="p">)</span></div>


<div class="viewcode-block" id="FunctionBlock.is_block_conditional">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.is_block_conditional">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_block_conditional</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">instr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_block_absolutejmp</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;switch&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">instr</span><span class="o">.</span><span class="n">is_branch</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="FunctionBlock.contains_instr">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.contains_instr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">contains_instr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__instrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="FunctionBlock.clear_next">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.clear_next">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nxt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nxt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_next</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></div>


<div class="viewcode-block" id="FunctionBlock.clear_prev">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.clear_prev">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_prev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prev</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prv</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_prev</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="FunctionBlock.clear_original_next">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.clear_original_next">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_original_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nxt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__original_cleared</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nxt</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__original_nexts</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_next</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__original_cleared</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FunctionBlock.clear_next_once">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.clear_next_once">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_next_once</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__was_cleared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__was_cleared</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_next</span><span class="p">()</span></div>


<div class="viewcode-block" id="FunctionBlock.is_block_switch">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.is_block_switch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_block_switch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;switch&#39;</span></div>


<div class="viewcode-block" id="FunctionBlock.is_block_absolutejmp">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.is_block_absolutejmp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_block_absolutejmp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">instr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;br&#39;</span> <span class="ow">or</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;br.s&#39;</span> <span class="ow">or</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;leave&#39;</span> <span class="ow">or</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;leave.s&#39;</span></div>

    
<div class="viewcode-block" id="FunctionBlock.is_block_direct">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.is_block_direct">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_block_direct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_block_absolutejmp</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_block_conditional</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">is_branch</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span></div>

    
<div class="viewcode-block" id="FunctionBlock.add_instr">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.add_instr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_instr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__instrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__start_offset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__start_offset</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__original_length</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span></div>


<div class="viewcode-block" id="FunctionBlock.remove_instrs_after_index">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.remove_instrs_after_index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_instrs_after_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__instrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__instrs</span><span class="p">[:</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="FunctionBlock.get_instrs">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_instrs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_instrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__instrs</span></div>


<div class="viewcode-block" id="FunctionBlock.get_start_offset">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_start_offset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_start_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__start_offset</span></div>


<div class="viewcode-block" id="FunctionBlock.get_last_instruction">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_last_instruction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_last_instruction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="FunctionBlock.has_prev">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.has_prev">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_prev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__previous</span></div>

    
<div class="viewcode-block" id="FunctionBlock.add_original_next">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.add_original_next">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_original_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
        <span class="c1">#Problem here: switch fallthrough case.  How do I handle it?  TODO: fix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__original_nexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_next</span><span class="p">(</span><span class="n">block</span><span class="p">)</span></div>


<div class="viewcode-block" id="FunctionBlock.add_next">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.add_next">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">block</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__next</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">block</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">block</span><span class="o">.</span><span class="n">has_prev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">block</span><span class="o">.</span><span class="n">__previous</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="FunctionBlock.has_next">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.has_next">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__next</span></div>


<div class="viewcode-block" id="FunctionBlock.get_next">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_next">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__next</span></div>


<div class="viewcode-block" id="FunctionBlock.get_prev">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_prev">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_prev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__previous</span></div>

    
<div class="viewcode-block" id="FunctionBlock.remove_prev">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.remove_prev">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_prev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prev</span><span class="p">):</span>
        <span class="n">prev</span><span class="o">.</span><span class="n">__next</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__previous</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span></div>


<div class="viewcode-block" id="FunctionBlock.get_last_instr">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.get_last_instr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_last_instr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="FunctionBlock.has_offset">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.has_offset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_finished</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__start_offset</span> <span class="o">&lt;=</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__start_offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__original_length</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">offset</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="FunctionBlock.validate_block">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.validate_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">last_instr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">last_instr</span><span class="o">.</span><span class="n">is_branch</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">last_instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ret&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__next</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__next</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">last_instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;switch&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__next</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__disasm_object</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="n">last_instr</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
            <span class="k">elif</span> <span class="n">last_instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;br.s&#39;</span> <span class="ow">or</span> <span class="n">last_instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;br&#39;</span> <span class="ow">or</span> <span class="n">last_instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;leave&#39;</span> <span class="ow">or</span> <span class="n">last_instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;leave.s&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__next</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__next</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span></div>


<div class="viewcode-block" id="FunctionBlock.split_block">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.split_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">split_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split_offset</span><span class="p">):</span>
        <span class="n">new_instrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">split_instrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">start_splitting</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">new_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__instrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">split_offset</span><span class="p">:</span>
                <span class="n">start_splitting</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">start_splitting</span><span class="p">:</span>
                <span class="n">new_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
                <span class="n">new_instrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">split_instrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__instrs</span> <span class="o">=</span> <span class="n">new_instrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__original_length</span> <span class="o">=</span> <span class="n">new_size</span>

        <span class="n">new_block</span> <span class="o">=</span> <span class="n">FunctionBlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__method_object</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__disasm_object</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__graph_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_try</span><span class="p">:</span>
            <span class="n">new_block</span><span class="o">.</span><span class="n">mark_block_try</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_catch</span><span class="p">:</span>
            <span class="n">new_block</span><span class="o">.</span><span class="n">mark_block_catch</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_block_finally</span><span class="p">:</span>
            <span class="n">new_block</span><span class="o">.</span><span class="n">mark_block_finally</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">split_instrs</span><span class="p">:</span>
            <span class="n">new_block</span><span class="o">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>

        <span class="n">new_next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__next</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">next</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__next</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_next</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>

        <span class="k">for</span> <span class="nb">next</span> <span class="ow">in</span> <span class="n">new_next</span><span class="p">:</span>
            <span class="n">new_block</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__next</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_block</span></div>


<div class="viewcode-block" id="FunctionBlock.remove_next">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.remove_next">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__next</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="n">block</span><span class="o">.</span><span class="n">__previous</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__original_nexts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__original_nexts</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span></div>


<div class="viewcode-block" id="FunctionBlock.replace_next">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionBlock.replace_next">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">new_block</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
            <span class="n">current_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__next</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_next</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">):</span>
                <span class="c1">#if the block is already there, in order to preserve order remove it.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">new_block</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__next</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">current_index</span><span class="p">,</span> <span class="n">new_block</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_block</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_block</span><span class="o">.</span><span class="n">has_prev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="n">new_block</span><span class="o">.</span><span class="n">__previous</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Block at offset </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">FunctionBlock</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span></div>

    
<span class="n">graph_id</span> <span class="o">=</span> <span class="mi">0</span>
<div class="viewcode-block" id="FunctionGraph">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionGraph">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FunctionGraph</span><span class="p">:</span>
    <span class="c1">#TODO: Add support for multiple switch statements - in the works.</span>
    <span class="c1">#TODO: Add support for try catch finally exception handling - Going to be very annoying.</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_object</span><span class="p">,</span> <span class="n">init_blocks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_print</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">graph_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__graph_id</span> <span class="o">=</span> <span class="n">graph_id</span>
        <span class="n">graph_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__method_object</span> <span class="o">=</span> <span class="n">method_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span> <span class="o">=</span> <span class="n">debug_print</span>
        <span class="k">if</span> <span class="n">init_blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__method_object</span><span class="o">.</span><span class="n">has_body</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__disasm_object</span> <span class="o">=</span> <span class="n">method_object</span><span class="o">.</span><span class="n">disassemble_method</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__handle_try_catch_finally_blocks</span><span class="p">()</span> <span class="c1"># first handle try catch finally since thats a special case.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sort_blocks</span><span class="p">()</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__root_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parse_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__disasm_object</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__root_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__sort_blocks</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">block</span><span class="o">.</span><span class="n">mark_block_finished</span><span class="p">()</span> <span class="c1">#Tell each block that we are done with our initial setup, anything else is a modification.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__sort_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
    
<div class="viewcode-block" id="FunctionGraph.enable_debug_printing">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionGraph.enable_debug_printing">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">enable_debug_printing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FunctionGraph.debug_printing_enabled">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionGraph.debug_printing_enabled">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">debug_printing_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span></div>


<div class="viewcode-block" id="FunctionGraph.set_root_block">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionGraph.set_root_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_root_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_block</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__root_block</span> <span class="o">=</span> <span class="n">root_block</span></div>


<div class="viewcode-block" id="FunctionGraph.get_root_block">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionGraph.get_root_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_root_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__root_block</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__should_split_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split_offset</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">instrs</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">split_offset</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">block</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__get_block_for_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">has_offset</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">block</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="FunctionGraph.analyze">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionGraph.analyze">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__analyze_switch_statements</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__handle_switch_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emu</span><span class="p">:</span> <span class="n">net_emulator</span><span class="o">.</span><span class="n">DotNetEmulator</span><span class="p">,</span> <span class="n">switch_block</span><span class="p">:</span> <span class="n">FunctionBlock</span><span class="p">,</span> <span class="n">child_block</span><span class="p">:</span> <span class="n">FunctionBlock</span><span class="p">,</span> <span class="n">usable_graph</span><span class="p">,</span> <span class="n">var_id_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">handled_blocks</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">localvars</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">previous_block</span><span class="p">:</span> <span class="n">FunctionBlock</span><span class="p">,</span> <span class="n">initial_child_block</span><span class="p">:</span> <span class="n">FunctionBlock</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="ow">in</span> <span class="n">handled_blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Returning from __handle_switch_statement because child block </span><span class="si">{}</span><span class="s1"> is in handled_blocks&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
            <span class="k">return</span>
        <span class="c1">#first check to see if this is a switch block. </span>
        <span class="k">if</span> <span class="n">child_block</span><span class="o">.</span><span class="n">is_block_switch</span><span class="p">()</span> <span class="ow">and</span> <span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="o">!=</span> <span class="n">switch_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">():</span>
            <span class="c1">#if it is a switch block, we need to find the initial block.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_suspicious_switch</span><span class="p">(</span><span class="n">child_block</span><span class="p">):</span> 
                <span class="k">if</span> <span class="n">initial_child_block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
                <span class="k">if</span> <span class="n">initial_child_block</span><span class="o">.</span><span class="n">is_switch_case</span><span class="p">():</span>
                    <span class="c1">#find the actual child block - this wont do.</span>
                    <span class="n">shortest_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shortest_path</span><span class="p">(</span><span class="n">initial_child_block</span><span class="p">,</span> <span class="n">child_block</span><span class="p">)</span>
                    <span class="n">actual_child_block</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">actual_child_block</span> <span class="ow">in</span> <span class="n">shortest_path</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">actual_child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="o">==</span> <span class="n">initial_child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">():</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_child_block</span><span class="o">.</span><span class="n">is_switch_case</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_child_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;1 calling analyze_switch_statement_internal with switch block </span><span class="si">{}</span><span class="s1"> and starting block </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">actual_child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__analyze_switch_statement_internal</span><span class="p">(</span><span class="n">child_block</span><span class="p">,</span> <span class="n">actual_child_block</span><span class="p">,</span> <span class="n">usable_graph</span><span class="p">,</span> <span class="n">handled_blocks</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;2 calling analyze_switch_statement_internal with switch block </span><span class="si">{}</span><span class="s1"> and starting block </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">initial_child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>

                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__analyze_switch_statement_internal</span><span class="p">(</span><span class="n">child_block</span><span class="p">,</span> <span class="n">initial_child_block</span><span class="p">,</span> <span class="n">usable_graph</span><span class="p">,</span> <span class="n">handled_blocks</span><span class="p">)</span>
        <span class="n">handled_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">is_block_absolutejmp</span><span class="p">(),</span> <span class="p">(</span><span class="ow">not</span> <span class="n">child_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">is_branch</span><span class="p">()</span> <span class="ow">and</span> <span class="n">child_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;switch&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">is_block_absolutejmp</span><span class="p">()</span> <span class="ow">or</span> <span class="n">child_block</span><span class="o">.</span><span class="n">is_block_direct</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">child_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">is_branch</span><span class="p">()</span> <span class="ow">and</span> <span class="n">child_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;switch&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span> 
            <span class="n">next_block</span><span class="p">:</span> <span class="n">FunctionBlock</span> <span class="o">=</span> <span class="n">child_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;next block stats </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">next_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="n">next_block</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">(),</span> <span class="n">next_block</span><span class="o">.</span><span class="n">is_switch_case</span><span class="p">(),</span> <span class="n">next_block</span><span class="o">.</span><span class="n">is_block_switch</span><span class="p">()))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">next_block</span><span class="o">.</span><span class="n">is_block_switch</span><span class="p">()</span> <span class="ow">or</span> <span class="n">switch_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="o">!=</span> <span class="n">next_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Going from block </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">next_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                <span class="k">if</span> <span class="n">initial_child_block</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling handle_switch_block (1)&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__handle_switch_block</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">switch_block</span><span class="p">,</span> <span class="n">next_block</span><span class="p">,</span> <span class="n">usable_graph</span><span class="p">,</span> <span class="n">var_id_no</span><span class="p">,</span> <span class="n">handled_blocks</span><span class="p">,</span> <span class="n">localvars</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">child_block</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling handle_switch_block (2)&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__handle_switch_block</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">switch_block</span><span class="p">,</span> <span class="n">next_block</span><span class="p">,</span> <span class="n">usable_graph</span><span class="p">,</span> <span class="n">var_id_no</span><span class="p">,</span> <span class="n">handled_blocks</span><span class="p">,</span> <span class="n">localvars</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">initial_child_block</span><span class="p">)</span>
        
        <span class="c1">#our next check - do we have a switch block that we need to handle?</span>
        
        <span class="n">usable_child_block</span> <span class="o">=</span> <span class="n">usable_graph</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling __handle_switch_statement with child_block </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>

        <span class="c1">#if all the block does is take our switch var and modify it, mark it as junk.</span>

        <span class="k">if</span> <span class="n">child_block</span><span class="o">.</span><span class="n">is_switch_case</span><span class="p">():</span>
            <span class="n">instrs</span> <span class="o">=</span> <span class="n">child_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ldloc&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()</span> <span class="o">==</span> <span class="n">var_id_no</span><span class="p">:</span>
                    <span class="n">allowed_instrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ldc.i4&#39;</span><span class="p">,</span> <span class="s1">&#39;mul&#39;</span><span class="p">,</span> <span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="s1">&#39;br.s&#39;</span><span class="p">,</span> <span class="s1">&#39;xor&#39;</span><span class="p">,</span> <span class="s1">&#39;nop&#39;</span><span class="p">]</span>
                    <span class="n">check_failed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_instrs</span><span class="p">:</span>
                            <span class="n">check_failed</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_failed</span><span class="p">:</span>
                        <span class="n">usable_child_block</span><span class="o">.</span><span class="n">mark_junk</span><span class="p">()</span>

        <span class="c1">#run the same check on the initial child_block just to be safe</span>
        <span class="k">if</span> <span class="n">initial_child_block</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">usable_initial_block</span> <span class="o">=</span> <span class="n">usable_graph</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">initial_child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">usable_initial_block</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">():</span>
                <span class="n">instrs</span> <span class="o">=</span> <span class="n">initial_child_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ldloc&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()</span> <span class="o">==</span> <span class="n">var_id_no</span><span class="p">:</span>
                        <span class="n">allowed_instrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ldc.i4&#39;</span><span class="p">,</span> <span class="s1">&#39;mul&#39;</span><span class="p">,</span> <span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="s1">&#39;br.s&#39;</span><span class="p">,</span> <span class="s1">&#39;xor&#39;</span><span class="p">,</span> <span class="s1">&#39;nop&#39;</span><span class="p">]</span>
                        <span class="n">check_failed</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_instrs</span><span class="p">:</span>
                                <span class="n">check_failed</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_failed</span><span class="p">:</span>
                            <span class="n">usable_initial_block</span><span class="o">.</span><span class="n">mark_junk</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">child_block</span><span class="o">.</span><span class="n">is_block_return</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;child_block.is_block_return(): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">child_block</span><span class="o">.</span><span class="n">is_block_conditional</span><span class="p">():</span>
            <span class="c1"># this may have the potential for issues if this isnt the last block in the case - FIXME</span>
            <span class="n">true_case</span> <span class="o">=</span> <span class="n">child_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">other_case</span> <span class="o">=</span> <span class="n">child_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">usable_child_block</span><span class="o">.</span><span class="n">clear_next_once</span><span class="p">()</span>
            <span class="n">usable_true_case</span> <span class="o">=</span> <span class="n">usable_graph</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">true_case</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
            <span class="n">usable_other_case</span> <span class="o">=</span> <span class="n">usable_graph</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">other_case</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding next of </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1"> as usable_true_case&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">usable_true_case</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">usable_child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
            <span class="n">usable_child_block</span><span class="o">.</span><span class="n">add_next</span><span class="p">(</span><span class="n">usable_true_case</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding next of </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1"> as usable_other_case&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">usable_other_case</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">usable_child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
            <span class="n">usable_child_block</span><span class="o">.</span><span class="n">add_next</span><span class="p">(</span><span class="n">usable_other_case</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__handle_switch_block</span><span class="p">(</span>
                <span class="n">emu</span><span class="p">,</span> <span class="n">switch_block</span><span class="p">,</span> <span class="n">true_case</span><span class="p">,</span> <span class="n">usable_graph</span><span class="p">,</span> <span class="n">var_id_no</span><span class="p">,</span> <span class="n">handled_blocks</span><span class="p">,</span> <span class="n">localvars</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">child_block</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__handle_switch_block</span><span class="p">(</span>
                <span class="n">emu</span><span class="p">,</span> <span class="n">switch_block</span><span class="p">,</span> <span class="n">other_case</span><span class="p">,</span> <span class="n">usable_graph</span><span class="p">,</span> <span class="n">var_id_no</span><span class="p">,</span> <span class="n">handled_blocks</span><span class="p">,</span> <span class="n">localvars</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">child_block</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;returning from __handle_switch_block because child_block has no next </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                <span class="k">return</span>
            <span class="c1"># not an if statement</span>
            <span class="n">math_instrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># this wont work in cases where its a pop etc</span>
            <span class="c1"># FIXME: figure out a better way to determine this.</span>
            <span class="k">if</span> <span class="n">initial_child_block</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;initial child block = </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">initial_child_block</span><span class="o">.</span><span class="n">is_block_switch</span><span class="p">(),</span> <span class="n">initial_child_block</span><span class="o">.</span><span class="n">is_switch_case</span><span class="p">(),</span> <span class="n">initial_child_block</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">()))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking initial child block </span><span class="si">{}</span><span class="s1"> for math instrs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">initial_child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">initial_child_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ldloc&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()</span> <span class="o">==</span> <span class="n">var_id_no</span><span class="p">:</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">is_branch</span><span class="p">():</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                        <span class="n">math_instrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking previous blocks just in case&#39;</span><span class="p">)</span>
                    <span class="c1">#check from the initial child block</span>
                    <span class="n">check_block</span> <span class="o">=</span> <span class="n">initial_child_block</span>
                    <span class="n">prev_block</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">check_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ldloc&#39;</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()</span> <span class="o">==</span> <span class="n">var_id_no</span><span class="p">:</span>
                                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">math_instrs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">instr</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                            <span class="c1">#check the previous block if theres only one</span>
                            <span class="k">if</span> <span class="n">prev_block</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">prev_block</span><span class="o">.</span><span class="n">is_block_absolutejmp</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">prev_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ldc.i4&#39;</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">prev_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dup&#39;</span><span class="p">:</span>
                                            <span class="n">math_instrs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">prev_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">check_block</span> <span class="o">==</span> <span class="n">child_block</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">prev_block</span> <span class="o">=</span> <span class="n">check_block</span>
                        <span class="n">check_block</span> <span class="o">=</span> <span class="n">check_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking child block </span><span class="si">{}</span><span class="s1"> for math instrs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">is_block_switch</span><span class="p">(),</span> <span class="n">child_block</span><span class="o">.</span><span class="n">is_switch_case</span><span class="p">(),</span> <span class="n">child_block</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">()))</span>
                <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">child_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ldloc&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()</span> <span class="o">==</span> <span class="n">var_id_no</span><span class="p">:</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">is_branch</span><span class="p">():</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                        <span class="n">math_instrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;if len(math_instrs) == 0:</span>
<span class="sd">                    #check if the last instruction is an ldc.i4.</span>
<span class="sd">                    if len(child_block.get_instrs()) &gt;= 2:</span>
<span class="sd">                        if len(child_block.get_next()) == 1 and child_block.get_next()[0].is_block_switch():</span>
<span class="sd">                            if child_block.get_instrs()[-2].get_name() == &#39;ldc.i4&#39;:</span>
<span class="sd">                                math_instrs.append(child_block.get_instrs()[-2])&quot;&quot;&quot;</span>
            
            <span class="c1">#do the ldloc check on the path.</span>
            
        
            <span class="c1">#if it directly leads to another block without a branch, check that block too.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Amount of math instrs found after child block check </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">math_instrs</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">math_instrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ucb</span><span class="p">:</span> <span class="n">FunctionBlock</span> <span class="o">=</span> <span class="n">child_block</span>
                <span class="n">prev_block</span><span class="p">:</span> <span class="n">FunctionBlock</span> <span class="o">=</span> <span class="n">ucb</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">ucb</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ucb</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">is_branch</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ucb</span><span class="o">.</span><span class="n">is_block_absolutejmp</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">prev_block</span> <span class="o">=</span> <span class="n">ucb</span>
                    <span class="n">ucb</span> <span class="o">=</span> <span class="n">ucb</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">ucb</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ldloc&#39;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()</span> <span class="o">==</span> <span class="n">var_id_no</span><span class="p">:</span>
                                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="c1">#additionally check if the previous block has just math instrs</span>
                                <span class="n">allowed_instrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ldc.i4&#39;</span><span class="p">,</span> <span class="s1">&#39;mul&#39;</span><span class="p">,</span> <span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="s1">&#39;br.s&#39;</span><span class="p">,</span> <span class="s1">&#39;xor&#39;</span><span class="p">,</span> <span class="s1">&#39;nop&#39;</span><span class="p">,</span> <span class="s1">&#39;dup&#39;</span><span class="p">]</span>
                                <span class="n">check_worked</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">for</span> <span class="n">instr2</span> <span class="ow">in</span> <span class="n">prev_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="n">instr2</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_instrs</span><span class="p">:</span>
                                        <span class="n">check_worked</span> <span class="o">=</span> <span class="kc">False</span>
                                        <span class="k">break</span>
                                <span class="k">if</span> <span class="n">check_worked</span><span class="p">:</span>
                                    <span class="n">math_instrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">is_branch</span><span class="p">():</span>
                                <span class="k">break</span>
                            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                                <span class="n">math_instrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Amount of math instrs found so far </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">math_instrs</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">math_instrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># there may be a case where its not based on that variable and is more so based off of a direct number, check that here.</span>
                <span class="c1"># FIXME: This is not the greatest solution to this problem, but it might work.</span>
                <span class="k">if</span> <span class="n">initial_child_block</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shortest_path</span><span class="p">(</span>
                        <span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">(),</span> <span class="n">switch_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shortest_path</span><span class="p">(</span><span class="n">initial_child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">(),</span> <span class="n">switch_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
                <span class="n">last_ldc_instr</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="n">switch_block</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ldc.&#39;</span><span class="p">):</span>
                                <span class="n">last_ldc_instr</span> <span class="o">=</span> <span class="n">instr</span>
                <span class="k">if</span> <span class="n">last_ldc_instr</span><span class="p">:</span>
                    <span class="n">math_instrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_ldc_instr</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">math_instrs</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(handle_switch_block): Running DotNetEmulator from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">math_instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">switch_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">offset</span><span class="p">)))</span>
            <span class="n">new_emu</span> <span class="o">=</span> <span class="n">net_emulator</span><span class="o">.</span><span class="n">DotNetEmulator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__method_object</span><span class="p">,</span> <span class="n">start_offset</span><span class="o">=</span><span class="n">math_instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
                                                  <span class="n">end_offset</span><span class="o">=</span><span class="n">switch_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">dont_execute_cctor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">new_emu</span><span class="o">.</span><span class="n">locals</span> <span class="o">=</span> <span class="n">localvars</span>
            <span class="n">new_emu</span><span class="o">.</span><span class="n">run_function</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_emu</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">EmulatorFailureException</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">new_emu</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">EmulatorFailureException</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">switch_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()):</span>
                <span class="n">next_block</span> <span class="o">=</span> <span class="n">switch_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">next_block</span> <span class="o">=</span> <span class="n">switch_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">usable_child_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">())</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">num_index</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">instr_offset</span> <span class="o">=</span> <span class="n">switch_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">get_arguments</span><span class="p">()[</span><span class="n">num_index</span><span class="p">:</span><span class="n">num_index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
            <span class="n">new_instr1</span> <span class="o">=</span> <span class="n">net_cil_disas</span><span class="o">.</span><span class="n">Instruction</span><span class="p">(</span><span class="n">net_opcodes</span><span class="o">.</span><span class="n">OpcodeCollection</span><span class="o">.</span><span class="n">get_opcode_by_name</span><span class="p">(</span><span class="s1">&#39;nop&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__method_object</span><span class="o">.</span><span class="n">disassemble_method</span><span class="p">(),</span>
                                                   <span class="n">offset</span><span class="o">=</span><span class="n">usable_child_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
            <span class="n">new_instr2</span> <span class="o">=</span> <span class="n">net_cil_disas</span><span class="o">.</span><span class="n">Instruction</span><span class="p">(</span><span class="n">net_opcodes</span><span class="o">.</span><span class="n">OpcodeCollection</span><span class="o">.</span><span class="n">get_opcode_by_name</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__method_object</span><span class="o">.</span><span class="n">disassemble_method</span><span class="p">(),</span>
                                                   <span class="n">offset</span><span class="o">=</span><span class="n">usable_child_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_instr1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">instr_offset</span><span class="p">:</span>
                <span class="n">new_instr2</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">usable_child_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">is_branch</span><span class="p">():</span>
                <span class="n">usable_child_block</span><span class="o">.</span><span class="n">replace_instr</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">new_instr1</span><span class="p">)</span>
                <span class="n">usable_child_block</span><span class="o">.</span><span class="n">replace_instr</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_instr2</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">usable_child_block</span><span class="o">.</span><span class="n">is_block_absolutejmp</span><span class="p">():</span>
                <span class="n">usable_child_block</span><span class="o">.</span><span class="n">clear_original_next</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;1: Adding next of </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">next_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">usable_child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                <span class="n">usable_child_block</span><span class="o">.</span><span class="n">add_next</span><span class="p">(</span>
                    <span class="n">usable_graph</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">next_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#This code is probably busted.  Take a look at what it was meant to do.</span>
                <span class="n">actual_block</span><span class="p">:</span> <span class="n">FunctionBlock</span> <span class="o">=</span> <span class="n">usable_child_block</span>
                <span class="n">switch_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shortest_path</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">switch_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting at actual block </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">actual_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                <span class="k">while</span> <span class="n">actual_block</span><span class="o">.</span><span class="n">is_block_absolutejmp</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1">#ok so what were looking for here is either the that is hit immediately before a switch statement.</span>
                    <span class="n">potential_block</span> <span class="o">=</span> <span class="n">actual_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">old_block</span><span class="p">:</span> <span class="n">FunctionBlock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">potential_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">old_next</span><span class="p">:</span> <span class="n">FunctionBlock</span> <span class="o">=</span> <span class="n">old_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">old_next</span><span class="o">.</span><span class="n">is_block_switch</span><span class="p">():</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">potential_block</span> <span class="ow">in</span> <span class="n">switch_path</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Going to block </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">potential_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                    <span class="n">actual_block</span> <span class="o">=</span> <span class="n">potential_block</span>
                <span class="n">actual_block</span><span class="o">.</span><span class="n">clear_original_next</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_block</span><span class="o">.</span><span class="n">is_block_return</span><span class="p">():</span> <span class="c1">#this appears to solve the issue of blocks with returns having children, not sure if this code is causing other issues though.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;2: Adding next of </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">next_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">actual_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                    <span class="n">actual_block</span><span class="o">.</span><span class="n">add_next</span><span class="p">(</span><span class="n">usable_graph</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">next_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__handle_switch_block</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">switch_block</span><span class="p">,</span> <span class="n">next_block</span><span class="p">,</span> <span class="n">usable_graph</span><span class="p">,</span> <span class="n">var_id_no</span><span class="p">,</span> <span class="n">handled_blocks</span><span class="p">,</span> <span class="n">localvars</span><span class="p">,</span> <span class="n">child_block</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished handling child block </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">child_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__cleanup_junk_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#handle root block being junk</span>
        <span class="n">usable_root</span><span class="p">:</span> <span class="n">FunctionBlock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__root_block</span>
        <span class="k">while</span> <span class="n">usable_root</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">usable_root</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
            <span class="n">usable_root</span> <span class="o">=</span> <span class="n">usable_root</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">usable_root</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__root_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__root_block</span> <span class="o">=</span> <span class="n">usable_root</span>
        <span class="n">block</span><span class="p">:</span> <span class="n">FunctionBlock</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1">#function block relations should be pretty consistent here.  junk blocks should only have ONE next.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">block</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">new_next</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">previous_block</span><span class="p">:</span> <span class="n">FunctionBlock</span>
                <span class="k">for</span> <span class="n">previous_block</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">get_prev</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
                    <span class="n">previous_block</span><span class="o">.</span><span class="n">replace_next</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">new_next</span><span class="p">)</span>
                <span class="c1">#so block is a junk block, just leads to another one with random crap.</span>
                <span class="n">block</span><span class="o">.</span><span class="n">remove_next</span><span class="p">(</span><span class="n">new_next</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">block</span><span class="o">.</span><span class="n">was_switch_block</span><span class="p">():</span>
                <span class="c1">#wipe this block out entirely.</span>
                <span class="n">block</span><span class="o">.</span><span class="n">clear_prev</span><span class="p">()</span>
                <span class="n">block</span><span class="o">.</span><span class="n">clear_next</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">block</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">():</span>
                <span class="k">pass</span> <span class="c1"># yaay our work is somehow already done for us.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">blk</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">blk</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span> <span class="c1"># what do we do here???</span>
        <span class="c1">#additionally remove nexts to blocks that are returns.</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">is_block_return</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">block</span><span class="o">.</span><span class="n">clear_next</span><span class="p">()</span>        

    <span class="k">def</span><span class="w"> </span><span class="nf">__is_suspicious_switch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
        <span class="n">instrs</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instrs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">has_rem</span> <span class="o">=</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rem&#39;</span> <span class="ow">or</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rem.un&#39;</span>
        <span class="n">has_args</span> <span class="o">=</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ldc.i4&#39;</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_argument</span><span class="p">())</span>
        <span class="n">has_stloc</span> <span class="o">=</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;stloc&#39;</span><span class="p">)</span>
        <span class="n">has_dup</span> <span class="o">=</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dup&#39;</span>
        <span class="k">return</span> <span class="n">has_rem</span> <span class="ow">and</span> <span class="n">has_stloc</span> <span class="ow">and</span> <span class="n">has_dup</span> <span class="ow">and</span> <span class="n">has_args</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__handle_try_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">try_offset</span><span class="p">,</span> <span class="n">try_length</span><span class="p">,</span> <span class="n">handler_offset</span><span class="p">,</span> <span class="n">handler_length</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parse_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__disasm_object</span><span class="p">,</span> <span class="n">try_offset</span><span class="p">,</span> <span class="n">try_offset</span> <span class="o">+</span> <span class="n">try_length</span><span class="p">,</span> <span class="n">is_try</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parse_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__disasm_object</span><span class="p">,</span> <span class="n">handler_offset</span><span class="p">,</span> <span class="n">handler_offset</span> <span class="o">+</span> <span class="n">handler_length</span><span class="p">,</span> <span class="n">is_catch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__handle_finally_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler_offset</span><span class="p">,</span> <span class="n">handler_length</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parse_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__disasm_object</span><span class="p">,</span> <span class="n">handler_offset</span><span class="p">,</span> <span class="n">handler_offset</span> <span class="o">+</span> <span class="n">handler_length</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__handle_try_catch_finally_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure that try catch finally blocks are treated as their own blocks.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">disasm_obj</span><span class="p">:</span> <span class="n">net_cil_disas</span><span class="o">.</span><span class="n">MethodDisassembler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__disasm_object</span>

        <span class="k">for</span> <span class="n">clause_flags</span><span class="p">,</span> <span class="n">try_offset</span><span class="p">,</span> <span class="n">try_length</span><span class="p">,</span> <span class="n">handler_offset</span><span class="p">,</span> <span class="n">handler_length</span><span class="p">,</span> <span class="n">class_token</span> <span class="ow">in</span> <span class="n">disasm_obj</span><span class="o">.</span><span class="n">exception_blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clause_flags</span> <span class="o">==</span> <span class="n">net_structs</span><span class="o">.</span><span class="n">COR_ILEXCEPTION_CLAUSE_EXCEPTION</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__handle_try_block</span><span class="p">(</span><span class="n">try_offset</span><span class="p">,</span> <span class="n">try_length</span><span class="p">,</span> <span class="n">handler_offset</span><span class="p">,</span> <span class="n">handler_length</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">clause_flags</span> <span class="o">==</span> <span class="n">net_structs</span><span class="o">.</span><span class="n">COR_ILEXCEPTION_CLAUSE_FINALLY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__handle_finally_block</span><span class="p">(</span><span class="n">handler_offset</span><span class="p">,</span> <span class="n">handler_length</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">OperationNotSupportedException</span><span class="p">()</span>
 

    <span class="k">def</span><span class="w"> </span><span class="nf">__analyze_switch_statement_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">switch_block</span><span class="p">:</span> <span class="n">FunctionBlock</span><span class="p">,</span> <span class="n">starting_block</span><span class="p">:</span> <span class="n">FunctionBlock</span><span class="p">,</span> <span class="n">usable_graph</span><span class="p">,</span> <span class="n">handled_blocks</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Some problems here:</span>
<span class="sd">        TODO</span>
<span class="sd">        We are assuming that the path to the switch block is direct - that may not be the case.  ConfuserEx may jump around a bit within the switch block</span>
<span class="sd">        Current possible solution would be to potentially iterate all possible paths of the function until we hit a switch block that is suspicious - then go through that path to determine the first one.</span>
<span class="sd">        It kindof has to be like handle_switch_block works in order to ensure the variables stay consistent - start with a copy of localvars etc etc.</span>
<span class="sd">        Solving this issue may be sortof hard, but is definitely needed for it to work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first identify the main source of the initial variable</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">__find_math_instrs</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="c1"># find the instructions executed to get the math for the initial switch done.</span>
            <span class="n">MATH_INSTRS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xor&#39;</span><span class="p">]</span>
            <span class="n">instrs</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()</span>
            <span class="n">math_instr</span> <span class="o">=</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">math_instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MATH_INSTRS</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Find math instrs returning none due to invalid operand instr?&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">USABLE_INSTRS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ldc.i4&#39;</span><span class="p">,</span> <span class="s1">&#39;rem.un&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MATH_INSTRS</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instrs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">instr</span> <span class="o">=</span> <span class="n">instrs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="n">is_usable</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">u_instr</span> <span class="ow">in</span> <span class="n">USABLE_INSTRS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">u_instr</span><span class="p">):</span>
                        <span class="n">is_usable</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">is_usable</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">instr</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">__requires_more_instructions</span><span class="p">(</span><span class="n">instrs</span><span class="p">):</span>
                <span class="c1"># does the initial math instruction have enough in the block to do its stuff?  Assume theres only one for now.</span>
                <span class="c1"># which one do we use?</span>
                <span class="n">amt_ldc</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instrs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ldc.&#39;</span><span class="p">):</span>
                        <span class="n">amt_ldc</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pop&#39;</span><span class="p">:</span>
                        <span class="n">amt_ldc</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dup&#39;</span><span class="p">:</span>
                        <span class="n">amt_ldc</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="ow">in</span> <span class="n">MATH_INSTRS</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">amt_ldc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">return</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">amt_ldc</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">return</span> <span class="mi">0</span>

            <span class="n">req_instrs</span> <span class="o">=</span> <span class="n">__requires_more_instructions</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">req_instrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;find math instrs requires more instrs&#39;</span><span class="p">)</span>
                <span class="n">block</span><span class="p">:</span> <span class="n">FunctionBlock</span>
                
                <span class="n">reversed_usable_path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ALLOWED_INSTRS</span> <span class="o">=</span> <span class="n">USABLE_INSTRS</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;dup&#39;</span><span class="p">,</span> <span class="s1">&#39;pop&#39;</span><span class="p">]</span>
                <span class="n">BREAK_INSTRS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="s1">&#39;callvirt&#39;</span><span class="p">,</span> <span class="s1">&#39;starg.s&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">reversed_usable_path</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="o">==</span> <span class="n">starting_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">():</span>
                        <span class="k">break</span>
                    <span class="n">should_end</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">is_block_conditional</span><span class="p">():</span>
                        <span class="k">break</span>
                    <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;stloc&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="ow">in</span> <span class="n">BREAK_INSTRS</span><span class="p">:</span>
                            <span class="n">should_end</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                        <span class="n">is_allowed</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">allowed_instr</span> <span class="ow">in</span> <span class="n">ALLOWED_INSTRS</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">allowed_instr</span><span class="p">):</span>
                                <span class="n">is_allowed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">is_allowed</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">instr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">should_end</span><span class="p">:</span>
                        <span class="k">break</span>


                <span class="n">req_instrs</span> <span class="o">=</span> <span class="n">__requires_more_instructions</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;requires instrs = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_instrs</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial child block = </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">starting_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">switch_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Result start = </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">),</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()))</span>
                
                <span class="c1">#TODO: revamp math instr getting.  Need to be able to properly account for different variables etc.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">req_instrs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Generate a new function graph to modify.</span>
        <span class="n">usable_switch_block</span><span class="p">:</span> <span class="n">FunctionBlock</span> <span class="o">=</span> <span class="n">usable_graph</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span>
            <span class="n">switch_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
        <span class="n">var_id_no</span> <span class="o">=</span> <span class="n">switch_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_suspicious_switch</span><span class="p">(</span><span class="n">switch_block</span><span class="p">):</span>
            <span class="n">block_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paths_to_block</span><span class="p">(</span><span class="n">starting_block</span><span class="p">,</span> <span class="n">switch_block</span><span class="p">)</span>
            <span class="n">one_path</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">block_paths</span><span class="p">:</span>
                <span class="c1">#ok so how do we determine which block to add the next at?</span>
                <span class="n">math_instrs</span> <span class="o">=</span> <span class="n">__find_math_instrs</span><span class="p">(</span><span class="n">switch_block</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(analyze_switch_statement): Handling switch statement </span><span class="si">{}</span><span class="s1"> path </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">switch_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                <span class="k">if</span> <span class="n">math_instrs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(analyze_switch_statement): Running DotNetEmulator from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">math_instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">math_instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
                    <span class="n">emu</span> <span class="o">=</span> <span class="n">net_emulator</span><span class="o">.</span><span class="n">DotNetEmulator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__method_object</span><span class="p">,</span> <span class="n">start_offset</span><span class="o">=</span><span class="n">math_instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
                                                    <span class="n">end_offset</span><span class="o">=</span><span class="n">math_instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dont_execute_cctor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">emu</span><span class="o">.</span><span class="n">run_function</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">emu</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">EmulatorFailureException</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">EmulatorFailureException</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">switch_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()):</span>
                        <span class="n">next_block</span> <span class="o">=</span> <span class="n">switch_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="n">value</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">next_block</span> <span class="o">=</span> <span class="n">switch_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">usable_switch_block</span><span class="o">.</span><span class="n">mark_switch_block</span><span class="p">()</span>
                    <span class="n">usable_prev_block</span> <span class="o">=</span> <span class="n">usable_switch_block</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">one_path</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;not one path = True </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">math_instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">)))</span>
                            <span class="k">for</span> <span class="n">tblock</span> <span class="ow">in</span> <span class="n">usable_graph</span><span class="o">.</span><span class="n">__blocks_start</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;usable graph has block </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">tblock</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                        <span class="n">usable_prev_block</span> <span class="o">=</span> <span class="n">usable_graph</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">math_instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
                    <span class="c1">#make sure math instrs are cleaned off in usable blocks.</span>
                    <span class="k">for</span> <span class="n">math_instr</span> <span class="ow">in</span> <span class="n">math_instrs</span><span class="p">:</span>
                        <span class="n">math_block</span><span class="p">:</span> <span class="n">FunctionBlock</span> <span class="o">=</span> <span class="n">usable_graph</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">math_instr</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">math_block</span><span class="p">:</span>
                            <span class="n">math_index</span> <span class="o">=</span> <span class="n">math_block</span><span class="o">.</span><span class="n">get_instr_index</span><span class="p">(</span><span class="n">math_instr</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">math_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">block_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">math_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">())</span>
                                <span class="n">should_remove</span> <span class="o">=</span> <span class="kc">False</span>

                                <span class="k">if</span> <span class="n">math_index</span> <span class="o">==</span> <span class="p">(</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                                    <span class="n">should_remove</span> <span class="o">=</span> <span class="kc">True</span>

                                <span class="k">if</span> <span class="n">math_index</span> <span class="o">==</span> <span class="p">(</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">math_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">is_branch</span><span class="p">()</span> <span class="ow">or</span> <span class="n">math_block</span><span class="o">.</span><span class="n">is_block_absolutejmp</span><span class="p">()):</span>
                                    <span class="n">should_remove</span> <span class="o">=</span> <span class="kc">True</span>

                                <span class="k">if</span> <span class="n">should_remove</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">math_index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">math_block</span><span class="o">.</span><span class="n">remove_instrs_after_index</span><span class="p">(</span><span class="n">math_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                
                        

                    <span class="n">usable_prev_block</span><span class="o">.</span><span class="n">clear_original_next</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;3: Adding next of </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">next_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">usable_prev_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>
                    <span class="n">usable_prev_block</span><span class="o">.</span><span class="n">add_next</span><span class="p">(</span>
                        <span class="n">usable_graph</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">next_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()))</span>
                    <span class="c1"># remove the switch, replace with jmp - for graphing purposes mostly.</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">usable_switch_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">num_index</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="n">instr_offset</span> <span class="o">=</span> <span class="n">switch_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">get_arguments</span><span class="p">()[</span><span class="n">num_index</span><span class="p">:</span><span class="n">num_index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
                    <span class="n">new_instr1</span> <span class="o">=</span> <span class="n">net_cil_disas</span><span class="o">.</span><span class="n">Instruction</span><span class="p">(</span><span class="n">net_opcodes</span><span class="o">.</span><span class="n">OpcodeCollection</span><span class="o">.</span><span class="n">get_opcode_by_name</span><span class="p">(</span><span class="s1">&#39;nop&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__method_object</span><span class="o">.</span><span class="n">disassemble_method</span><span class="p">(),</span>
                                                        <span class="n">offset</span><span class="o">=</span><span class="n">switch_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
                    <span class="n">new_instr2</span> <span class="o">=</span> <span class="n">net_cil_disas</span><span class="o">.</span><span class="n">Instruction</span><span class="p">(</span><span class="n">net_opcodes</span><span class="o">.</span><span class="n">OpcodeCollection</span><span class="o">.</span><span class="n">get_opcode_by_name</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__method_object</span><span class="o">.</span><span class="n">disassemble_method</span><span class="p">(),</span>
                                                        <span class="n">offset</span><span class="o">=</span><span class="n">switch_block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_instr1</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">instr_offset</span><span class="p">:</span>
                        <span class="n">new_instr2</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="n">usable_switch_block</span><span class="o">.</span><span class="n">replace_instr</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_instr1</span><span class="p">)</span>
                    <span class="n">usable_switch_block</span><span class="o">.</span><span class="n">replace_instr</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">new_instr2</span><span class="p">)</span>
                    <span class="n">usable_switch_block</span><span class="o">.</span><span class="n">mark_junk</span><span class="p">()</span>
                    <span class="c1"># figure out noping math instrs later, for now pop the value off the stack.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__handle_switch_block</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">switch_block</span><span class="p">,</span> <span class="n">next_block</span><span class="p">,</span> <span class="n">usable_graph</span><span class="p">,</span> <span class="n">var_id_no</span><span class="p">,</span> <span class="n">handled_blocks</span><span class="p">,</span> <span class="n">emu</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">usable_block</span><span class="p">:</span> <span class="n">FunctionBlock</span>
                    <span class="k">for</span> <span class="n">usable_block</span> <span class="ow">in</span> <span class="n">usable_graph</span><span class="o">.</span><span class="n">__blocks_start</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">():</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">is_switch_case</span><span class="p">():</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usable_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ldc.i4&#39;</span><span class="p">:</span>
                                    <span class="n">usable_block</span><span class="o">.</span><span class="n">mark_junk</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">usable_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">instr1</span> <span class="o">=</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">instr2</span> <span class="o">=</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">instr1</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;nop&#39;</span> <span class="ow">or</span> <span class="n">instr1</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pop&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">instr2</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;br.s&#39;</span> <span class="ow">or</span> <span class="n">instr2</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;br&#39;</span><span class="p">:</span>
                                    <span class="n">usable_block</span><span class="o">.</span><span class="n">mark_junk</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">usable_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">instr1</span> <span class="o">=</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">instr2</span> <span class="o">=</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">instr3</span> <span class="o">=</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">instr1</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ldc.i4&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">instr2</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;nop&#39;</span> <span class="ow">or</span> <span class="n">instr2</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dup&#39;</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">instr3</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;br.s&#39;</span> <span class="ow">or</span> <span class="n">instr3</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;br&#39;</span><span class="p">:</span>
                                    <span class="n">usable_block</span><span class="o">.</span><span class="n">mark_junk</span><span class="p">()</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">():</span>
                            <span class="n">instrs</span> <span class="o">=</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()</span>

                            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">instrs</span><span class="p">)):</span>
                                <span class="n">instr</span> <span class="o">=</span> <span class="n">instrs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ldloc&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()</span> <span class="o">==</span> <span class="n">var_id_no</span><span class="p">:</span>
                                    <span class="n">usable_block</span><span class="o">.</span><span class="n">remove_instrs_after_index</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ldc.i4&#39;</span> <span class="ow">and</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dup&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usable_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_switch_case</span><span class="p">():</span>
                                        <span class="n">usable_block</span><span class="o">.</span><span class="n">mark_junk</span><span class="p">()</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">instrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ldc.i4&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usable_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_switch_case</span><span class="p">():</span>
                                        <span class="n">usable_block</span><span class="o">.</span><span class="n">mark_junk</span><span class="p">()</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">instrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ldc.i4&#39;</span> <span class="ow">and</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dup&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;br&#39;</span> <span class="ow">or</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;br.s&#39;</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usable_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_switch_case</span><span class="p">():</span>
                                            <span class="n">usable_block</span><span class="o">.</span><span class="n">mark_junk</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">usable_block</span> <span class="ow">in</span> <span class="n">usable_graph</span><span class="o">.</span><span class="n">__blocks_start</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">():</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usable_block</span><span class="o">.</span><span class="n">get_prev</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">get_prev</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">():</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usable_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">usable_block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pop&#39;</span><span class="p">:</span>
                                    <span class="n">usable_block</span><span class="o">.</span><span class="n">mark_junk</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">usable_graph</span>
        <span class="k">return</span> <span class="kc">None</span>
    
<div class="viewcode-block" id="FunctionGraph.get_shortest_path">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionGraph.get_shortest_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_shortest_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_offset</span><span class="p">,</span> <span class="n">to_offset</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_offset</span><span class="p">,</span> <span class="n">FunctionBlock</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">from_offset</span><span class="p">,</span> <span class="n">FunctionBlock</span><span class="p">):</span>
            <span class="n">to_block</span> <span class="o">=</span> <span class="n">to_offset</span>
            <span class="n">from_block</span> <span class="o">=</span> <span class="n">from_offset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">to_offset</span><span class="p">)</span>
            <span class="n">from_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">from_offset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">to_block</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">from_block</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>

        <span class="n">explored</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="p">[[</span><span class="n">from_block</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">to_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="o">==</span> <span class="n">from_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">from_block</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">explored</span><span class="p">:</span>
                <span class="n">neighbours</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
                    <span class="n">new_path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">new_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbor</span><span class="p">)</span>
                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">neighbor</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="o">==</span> <span class="n">to_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">():</span>
                        <span class="k">return</span> <span class="n">new_path</span>
                <span class="n">explored</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="FunctionGraph.get_paths_to_block">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionGraph.get_paths_to_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_paths_to_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_offset</span><span class="p">,</span> <span class="n">from_offset</span><span class="p">):</span>
        <span class="n">to_block</span> <span class="o">=</span> <span class="n">to_offset</span>
        <span class="n">from_block</span> <span class="o">=</span> <span class="n">from_offset</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_block</span><span class="p">,</span> <span class="n">FunctionBlock</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">from_block</span><span class="p">,</span> <span class="n">FunctionBlock</span><span class="p">):</span>
            <span class="n">to_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">to_block</span><span class="p">)</span>
            <span class="n">from_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="n">from_block</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">path_checker</span><span class="p">(</span><span class="n">one</span><span class="p">:</span> <span class="n">FunctionBlock</span><span class="p">,</span> <span class="n">two</span><span class="p">:</span> <span class="n">FunctionBlock</span><span class="p">,</span> <span class="n">current_path</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">visited</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">one</span> <span class="o">==</span> <span class="n">two</span><span class="p">:</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_path</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">one</span><span class="o">.</span><span class="n">is_block_return</span><span class="p">():</span>
                <span class="k">return</span>
            
            <span class="k">if</span> <span class="n">one</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">return</span>
            
            <span class="n">visited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
            
            <span class="n">nxt</span><span class="p">:</span> <span class="n">FunctionBlock</span>
            <span class="k">for</span> <span class="n">nxt</span> <span class="ow">in</span> <span class="n">one</span><span class="o">.</span><span class="n">get_next</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">nxt</span> <span class="o">==</span> <span class="n">two</span><span class="p">:</span>
                    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_path</span> <span class="o">+</span> <span class="p">[</span><span class="n">nxt</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">path_checker</span><span class="p">(</span><span class="n">nxt</span><span class="p">,</span> <span class="n">two</span><span class="p">,</span> <span class="n">current_path</span> <span class="o">+</span> <span class="p">[</span><span class="n">nxt</span><span class="p">],</span> <span class="n">paths</span><span class="p">,</span> <span class="n">visited</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="n">paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">path_checker</span><span class="p">(</span><span class="n">to_block</span><span class="p">,</span> <span class="n">from_block</span><span class="p">,</span> <span class="p">[</span><span class="n">to_block</span><span class="p">],</span> <span class="n">paths</span><span class="p">,</span> <span class="n">visited</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">paths</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__analyze_switch_statements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">usable_graph</span> <span class="o">=</span> <span class="n">FunctionGraph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__method_object</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Before analyze graph:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">usable_graph</span><span class="o">.</span><span class="n">print_root</span><span class="p">()</span>

        <span class="n">handled_blocks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking block </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_last_instr</span><span class="p">()</span><span class="o">.</span><span class="n">offset</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">contains_instr</span><span class="p">(</span><span class="s1">&#39;switch&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;block contains switch&#39;</span><span class="p">)</span>
                <span class="c1">#for now start at block zero, this will need to be changed to support multiple switch statements.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;3: calling analyze_switch_statement_internal with switch block </span><span class="si">{}</span><span class="s1"> and starting block 0x0&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span>

                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__analyze_switch_statement_internal</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">usable_graph</span><span class="p">,</span> <span class="n">handled_blocks</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dumping usable graph before cleanup:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">usable_graph</span><span class="o">.</span><span class="n">print_root</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">usable_graph</span><span class="o">.</span><span class="n">__cleanup_junk_blocks</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug_print</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dumping usable graph post cleanup:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">usable_graph</span><span class="o">.</span><span class="n">print_root</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">usable_graph</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__parse_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disasm_obj</span><span class="p">,</span> <span class="n">start_offset</span><span class="p">,</span> <span class="n">max_end_offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_try</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_catch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_finally</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">usable_offset</span> <span class="o">=</span> <span class="n">start_offset</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">disasm_obj</span><span class="o">.</span><span class="n">get_instr_index_by_offset</span><span class="p">(</span><span class="n">start_offset</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;parsing block with offset </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">start_offset</span><span class="p">)))</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">FunctionBlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__method_object</span><span class="p">,</span> <span class="n">disasm_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__graph_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="p">:</span>
            <span class="n">blk</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="p">[</span><span class="n">start_offset</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">blk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="p">[</span><span class="n">start_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span>

        <span class="k">if</span> <span class="n">is_finally</span><span class="p">:</span>
            <span class="n">block</span><span class="o">.</span><span class="n">mark_block_finally</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">is_catch</span><span class="p">:</span>
            <span class="n">block</span><span class="o">.</span><span class="n">mark_block_catch</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">is_try</span><span class="p">:</span>
            <span class="n">block</span><span class="o">.</span><span class="n">mark_block_try</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">disasm_obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">usable_offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span> <span class="ow">and</span> <span class="n">usable_offset</span> <span class="o">!=</span> <span class="n">start_offset</span><span class="p">:</span>
                <span class="n">new_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="p">[</span><span class="n">usable_offset</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">block</span><span class="o">.</span><span class="n">has_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">):</span>
                    <span class="n">block</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">max_end_offset</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">usable_offset</span> <span class="o">&gt;=</span> <span class="n">max_end_offset</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">instr</span> <span class="o">=</span> <span class="n">disasm_obj</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="n">block</span><span class="o">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">is_branch</span><span class="p">():</span>
                <span class="c1">#leave br and br.s are treated as absolute jumps since they basically are.</span>
                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;br&#39;</span> <span class="ow">or</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;br.s&#39;</span> <span class="ow">or</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;leave&#39;</span> <span class="ow">or</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;leave.s&#39;</span><span class="p">:</span>
                    <span class="n">potential_offset</span> <span class="o">=</span> <span class="n">usable_offset</span> <span class="o">+</span> \
                        <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span> <span class="o">+</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()</span>
                    <span class="n">split_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__should_split_block</span><span class="p">(</span><span class="n">potential_offset</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">split_block</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">new_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parse_block</span><span class="p">(</span>
                            <span class="n">disasm_obj</span><span class="p">,</span> <span class="n">potential_offset</span><span class="p">,</span> <span class="n">max_end_offset</span><span class="o">=</span><span class="n">max_end_offset</span><span class="p">,</span> <span class="n">is_try</span><span class="o">=</span><span class="n">is_try</span><span class="p">,</span> <span class="n">is_catch</span><span class="o">=</span><span class="n">is_catch</span><span class="p">,</span> <span class="n">is_finally</span><span class="o">=</span><span class="n">is_finally</span><span class="p">)</span>
                        <span class="n">usable_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span>
                            <span class="n">usable_offset</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">new_block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
                        <span class="n">usable_block</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_block</span> <span class="o">=</span> <span class="n">split_block</span><span class="o">.</span><span class="n">split_block</span><span class="p">(</span><span class="n">potential_offset</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="p">[</span><span class="n">new_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">(</span>
                        <span class="p">)]</span> <span class="o">=</span> <span class="n">new_block</span>
                        <span class="n">block</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;switch&#39;</span><span class="p">:</span>
                        <span class="n">targets</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
                            <span class="n">split_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__should_split_block</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">split_block</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">new_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parse_block</span><span class="p">(</span>
                                    <span class="n">disasm_obj</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">max_end_offset</span><span class="p">,</span> <span class="n">is_try</span><span class="p">,</span> <span class="n">is_catch</span><span class="p">,</span> <span class="n">is_finally</span><span class="p">)</span>
                                <span class="n">usable_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span>
                                    <span class="n">usable_offset</span><span class="p">)</span>
                                <span class="n">usable_block</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
                                <span class="n">new_block</span><span class="o">.</span><span class="n">mark_switch_case</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">new_block</span> <span class="o">=</span> <span class="n">split_block</span><span class="o">.</span><span class="n">split_block</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="p">[</span><span class="n">new_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">(</span>
                                <span class="p">)]</span> <span class="o">=</span> <span class="n">new_block</span>
                                <span class="n">usable_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span>
                                    <span class="n">instr</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
                                <span class="n">usable_block</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
                                <span class="n">new_block</span><span class="o">.</span><span class="n">mark_switch_case</span><span class="p">()</span>

                        <span class="n">fallthrough_offset</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
                        <span class="n">split_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__should_split_block</span><span class="p">(</span><span class="n">fallthrough_offset</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">split_block</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">new_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parse_block</span><span class="p">(</span>
                                <span class="n">disasm_obj</span><span class="p">,</span> <span class="n">fallthrough_offset</span><span class="p">,</span> <span class="n">max_end_offset</span><span class="p">,</span> <span class="n">is_try</span><span class="p">,</span> <span class="n">is_catch</span><span class="p">,</span> <span class="n">is_finally</span><span class="p">)</span>
                            <span class="n">usable_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span>
                                <span class="n">usable_offset</span><span class="p">)</span>
                            <span class="n">usable_block</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
                            <span class="n">new_block</span><span class="o">.</span><span class="n">mark_switch_case</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_block</span> <span class="o">=</span> <span class="n">split_block</span><span class="o">.</span><span class="n">split_block</span><span class="p">(</span><span class="n">fallthrough_offset</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="p">[</span><span class="n">new_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">(</span>
                            <span class="p">)]</span> <span class="o">=</span> <span class="n">new_block</span>
                            <span class="n">usable_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span>
                                <span class="n">instr</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
                            <span class="n">usable_block</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
                            <span class="n">new_block</span><span class="o">.</span><span class="n">mark_switch_case</span><span class="p">()</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#this block of code is to handle conditional branches.</span>
                        <span class="n">potential_offset1</span> <span class="o">=</span> <span class="n">usable_offset</span> <span class="o">+</span> \
                            <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span> <span class="o">+</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()</span>
                        <span class="n">potential_offset2</span> <span class="o">=</span> <span class="n">usable_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
                        <span class="n">split_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__should_split_block</span><span class="p">(</span>
                            <span class="n">potential_offset1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">split_block</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">new_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parse_block</span><span class="p">(</span>
                                <span class="n">disasm_obj</span><span class="p">,</span> <span class="n">potential_offset1</span><span class="p">,</span> <span class="n">max_end_offset</span><span class="p">,</span> <span class="n">is_try</span><span class="p">,</span> <span class="n">is_catch</span><span class="p">,</span> <span class="n">is_finally</span><span class="p">)</span>
                            <span class="n">usable_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span>
                                <span class="n">usable_offset</span><span class="p">)</span>
                            <span class="n">usable_block</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_block</span> <span class="o">=</span> <span class="n">split_block</span><span class="o">.</span><span class="n">split_block</span><span class="p">(</span>
                                <span class="n">potential_offset1</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="p">[</span><span class="n">new_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">(</span>
                            <span class="p">)]</span> <span class="o">=</span> <span class="n">new_block</span>
                            <span class="n">usable_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span>
                                <span class="n">instr</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
                            <span class="n">usable_block</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
                        <span class="n">split_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__should_split_block</span><span class="p">(</span>
                            <span class="n">potential_offset2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">split_block</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">new_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parse_block</span><span class="p">(</span>
                                <span class="n">disasm_obj</span><span class="p">,</span> <span class="n">potential_offset2</span><span class="p">,</span> <span class="n">max_end_offset</span><span class="p">,</span> <span class="n">is_try</span><span class="p">,</span> <span class="n">is_catch</span><span class="p">,</span> <span class="n">is_finally</span><span class="p">)</span>
                            <span class="n">usable_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__should_split_block</span><span class="p">(</span>
                                <span class="n">usable_offset</span><span class="p">)</span>
                            <span class="n">usable_block</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_block</span> <span class="o">=</span> <span class="n">split_block</span><span class="o">.</span><span class="n">split_block</span><span class="p">(</span>
                                <span class="n">potential_offset2</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="p">[</span><span class="n">new_block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">(</span>
                            <span class="p">)]</span> <span class="o">=</span> <span class="n">new_block</span>
                            <span class="n">usable_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_block_for_offset</span><span class="p">(</span>
                                <span class="n">instr</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
                            <span class="n">usable_block</span><span class="o">.</span><span class="n">add_original_next</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">usable_offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ret&#39;</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">is_branch</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;br.s&#39;</span> <span class="ow">and</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;br&#39;</span> <span class="ow">and</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;leave&#39;</span> <span class="ow">and</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;leave.s&#39;</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">disasm_obj</span><span class="o">.</span><span class="n">get_instr_index_by_offset</span><span class="p">(</span><span class="n">usable_offset</span><span class="p">)</span>
        <span class="c1">#block.validate_block()</span>
        <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>

        <span class="k">return</span> <span class="n">block</span>

<div class="viewcode-block" id="FunctionGraph.print_root">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionGraph.print_root">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dont_print_again</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__print_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__root_block</span><span class="p">,</span> <span class="n">dont_print_again</span><span class="p">)</span></div>


<div class="viewcode-block" id="FunctionGraph.debug_print_nexts">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionGraph.debug_print_nexts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">debug_print_nexts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">block</span><span class="p">:</span> <span class="n">FunctionBlock</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Debug printing blocks&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Block </span><span class="si">{}</span><span class="s1"> is_junk=</span><span class="si">{}</span><span class="s1"> is_switch_case=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="n">block</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">(),</span> <span class="n">block</span><span class="o">.</span><span class="n">is_switch_case</span><span class="p">()))</span>
            <span class="n">nxt</span><span class="p">:</span> <span class="n">FunctionBlock</span>
            <span class="k">for</span> <span class="n">nxt</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Next: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">nxt</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span></div>


<div class="viewcode-block" id="FunctionGraph.get_block_offsets">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.FunctionGraph.get_block_offsets">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_block_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blocks_start</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__print_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">already_printed</span><span class="p">):</span>

        <span class="n">instrs</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already_printed</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Printing block with offset </span><span class="si">{}</span><span class="s1"> (is junk: </span><span class="si">{}</span><span class="s1">, is switch case: </span><span class="si">{}</span><span class="s1">, is_try: </span><span class="si">{}</span><span class="s1">, is_catch: </span><span class="si">{}</span><span class="s1">, is_finally: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">hex</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="n">block</span><span class="o">.</span><span class="n">is_junk_block</span><span class="p">(),</span> <span class="n">block</span><span class="o">.</span><span class="n">is_switch_case</span><span class="p">(),</span> <span class="n">block</span><span class="o">.</span><span class="n">is_block_try</span><span class="p">(),</span> <span class="n">block</span><span class="o">.</span><span class="n">is_block_catch</span><span class="p">(),</span> <span class="n">block</span><span class="o">.</span><span class="n">is_block_finally</span><span class="p">()))</span>
            <span class="n">already_printed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">is_branch</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">instr</span><span class="o">.</span><span class="n">is_absolute_jmp</span><span class="p">():</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">is_absolute_jmp</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: jump to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">offset</span><span class="p">),</span>
                                                  <span class="nb">hex</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span> <span class="o">+</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_argument</span><span class="p">())))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">offset</span><span class="p">),</span> <span class="n">instr</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                                             <span class="n">instr</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()))</span>

            <span class="k">if</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;switch&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;switch (</span><span class="si">{}</span><span class="s1">):&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">)))</span>
                <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_argument</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;case </span><span class="si">{}</span><span class="s1">: (</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">case</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__print_block</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="n">x</span><span class="p">],</span> <span class="n">already_printed</span><span class="p">)</span>
                    <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">fallthrough</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;default(</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">):&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">fallthrough</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">()),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__print_block</span><span class="p">(</span><span class="n">fallthrough</span><span class="p">,</span> <span class="n">already_printed</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_branch</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_absolute_jmp</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;if (</span><span class="si">{}</span><span class="s1">): </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">),</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span><span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_argument</span><span class="p">()))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__print_block</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">already_printed</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;else (</span><span class="si">{}</span><span class="s1">):&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: No secondary block!!!!&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__print_block</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">already_printed</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_branch</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__print_block</span><span class="p">(</span>
                            <span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">already_printed</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_absolute_jmp</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_branch</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__print_block</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">already_printed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;goto block </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_start_offset</span><span class="p">())))</span></div>


<div class="viewcode-block" id="GraphRecompiler">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.GraphRecompiler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GraphRecompiler</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_obj</span><span class="p">:</span> <span class="n">net_row_objects</span><span class="o">.</span><span class="n">MethodDef</span><span class="p">,</span> <span class="n">func_graph</span><span class="p">:</span> <span class="n">FunctionGraph</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__method_obj</span><span class="p">:</span> <span class="n">net_row_objects</span><span class="o">.</span><span class="n">MethodDef</span> <span class="o">=</span> <span class="n">method_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__func_graph</span><span class="p">:</span> <span class="n">FunctionGraph</span> <span class="o">=</span> <span class="n">func_graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__block_locations</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__convert_small_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opcode</span><span class="p">):</span>
        <span class="c1">#for usability sake, convert a small instruction to its large counterpart.  For example, blt.s -&gt; blt.</span>
        <span class="k">match</span> <span class="n">opcode</span><span class="p">:</span>
            <span class="k">case</span> <span class="mh">0x2E</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x3B</span>
            <span class="k">case</span> <span class="mh">0x2F</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x3C</span>
            <span class="k">case</span> <span class="mh">0x34</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x41</span>
            <span class="k">case</span> <span class="mh">0x30</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x3D</span>
            <span class="k">case</span> <span class="mh">0x35</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x42</span>
            <span class="k">case</span> <span class="mh">0x31</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x3E</span>
            <span class="k">case</span> <span class="mh">0x36</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x43</span>
            <span class="k">case</span> <span class="mh">0x32</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x3F</span>
            <span class="k">case</span> <span class="mh">0x37</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x44</span>
            <span class="k">case</span> <span class="mh">0x33</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x40</span>
            <span class="k">case</span> <span class="mh">0x2B</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x38</span>
            <span class="k">case</span> <span class="mh">0x2C</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x39</span>
            <span class="k">case</span> <span class="mh">0x2D</span><span class="p">:</span>
                <span class="k">return</span> <span class="mh">0x3A</span>
        <span class="k">return</span> <span class="n">opcode</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__compile_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span><span class="n">FunctionBlock</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__block_locations</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">current_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__block_locations</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_offset</span>
        <span class="n">instrs</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get_instrs</span><span class="p">()</span>
        <span class="n">last_instr_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instrs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instrs</span><span class="p">)):</span>
            <span class="n">instr</span> <span class="o">=</span> <span class="n">instrs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">last_instr_index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">is_branch</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">is_block_absolutejmp</span><span class="p">():</span>
                        <span class="c1">#if the block is absolute jump it means this instr is br or br.s</span>
                        <span class="c1">#two options here: either we already compiled the block and need a new br instruction, or we havent and we can compile it without this br instr.</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
                        <span class="n">next_block</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">next_block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__block_locations</span><span class="p">:</span>
                            <span class="c1">#we need a new BR to jump to it probably</span>
                            <span class="n">block_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__block_locations</span><span class="p">[</span><span class="n">next_block</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">block_offset</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">):</span> <span class="c1">#TODO: This probably wont ever be false.</span>
                                <span class="n">br_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">)</span>
                                <span class="n">new_br_offset</span> <span class="o">=</span> <span class="n">block_offset</span> <span class="o">-</span> <span class="n">br_offset</span> <span class="o">-</span> <span class="mi">5</span>
                                <span class="n">br_instr</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mh">0x38</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">new_br_offset</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span> <span class="o">+=</span> <span class="n">br_instr</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1">#just compile the block right after</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__compile_block</span><span class="p">(</span><span class="n">next_block</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">block</span><span class="o">.</span><span class="n">is_block_switch</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;switch statements are not currently supported.&quot;</span><span class="p">)</span> <span class="c1">#TODO: add support for actual legitimate switch statements.</span>
                    <span class="k">elif</span> <span class="n">block</span><span class="o">.</span><span class="n">is_block_conditional</span><span class="p">():</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
                        <span class="n">instr_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">)</span> <span class="c1"># offset of the placeholder.</span>
                        <span class="n">true_case</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># This should be the jump case</span>
                        <span class="n">false_case</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#this should be fallthrough.</span>
                        <span class="c1">#first check if the fallthrough case has been compiled - reserve enough bytes for the conditional instruction and then compile it if it hasnt already.</span>
                        <span class="k">if</span> <span class="n">false_case</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__block_locations</span><span class="p">:</span>
                            <span class="c1">#we need to compile the false case.  add the placeholder</span>
                            <span class="n">placeholder</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">5</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span> <span class="o">+=</span> <span class="n">placeholder</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__compile_block</span><span class="p">(</span><span class="n">false_case</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">placeholder</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">5</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span> <span class="o">+=</span> <span class="n">placeholder</span>
                            <span class="n">block_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__block_locations</span><span class="p">[</span><span class="n">false_case</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">block_offset</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">):</span> <span class="c1">#TODO: This probably wont ever be false.</span>
                                <span class="n">br_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">)</span>
                                <span class="n">new_br_offset</span> <span class="o">=</span> <span class="n">block_offset</span> <span class="o">-</span> <span class="n">br_offset</span> <span class="o">-</span> <span class="mi">5</span>
                                <span class="n">br_instr</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mh">0x38</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">new_br_offset</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span> <span class="o">+=</span> <span class="n">br_instr</span>
                        <span class="c1">#now for the true case and replacing the placeholder.</span>
                        <span class="k">if</span> <span class="n">true_case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__block_locations</span><span class="p">:</span>
                            <span class="n">block_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__block_locations</span><span class="p">[</span><span class="n">true_case</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">block_offset</span> <span class="o">!=</span> <span class="n">instr_offset</span><span class="p">:</span> <span class="c1">#TODO: This probably wont ever be false.</span>
                                <span class="n">br_offset</span> <span class="o">=</span> <span class="n">instr_offset</span>
                                <span class="n">new_br_offset</span> <span class="o">=</span> <span class="n">block_offset</span> <span class="o">-</span> <span class="n">br_offset</span> <span class="o">-</span> <span class="mi">5</span>
                                <span class="n">br_instr</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__convert_small_instructions</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">get_opcode</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">)])</span> <span class="o">+</span> <span class="nb">int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">new_br_offset</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">[:</span><span class="n">instr_offset</span><span class="p">]</span> <span class="o">+</span> <span class="n">br_instr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">[</span><span class="n">instr_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">placeholder</span><span class="p">):]</span> <span class="c1"># remove the placeholder.</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1">#its not compiled.  compile it and then remove the placeholder.</span>
                            <span class="n">compilation_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__compile_block</span><span class="p">(</span><span class="n">true_case</span><span class="p">)</span>
                            <span class="n">br_offset</span> <span class="o">=</span> <span class="n">instr_offset</span>
                            <span class="n">new_br_offset</span> <span class="o">=</span> <span class="n">compilation_offset</span> <span class="o">-</span> <span class="n">br_offset</span> <span class="o">-</span> <span class="mi">5</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">get_opcode</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
                            <span class="n">br_instr</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__convert_small_instructions</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">get_opcode</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">)])</span> <span class="o">+</span> <span class="nb">int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">new_br_offset</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">[:</span><span class="n">instr_offset</span><span class="p">]</span> <span class="o">+</span> <span class="n">br_instr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">[</span><span class="n">instr_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">placeholder</span><span class="p">):]</span> <span class="c1"># again remove the placeholder</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidAssemblyException</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span> <span class="o">+=</span> <span class="n">instr</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
                    <span class="c1">#check if the block was already compiled, if so add a BR</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">net_exceptions</span><span class="o">.</span><span class="n">InvalidBlockException</span>
                        <span class="n">next_block</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">next_block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__block_locations</span><span class="p">:</span>
                            <span class="c1">#add a br to the start of the block.</span>
                            <span class="n">block_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__block_locations</span><span class="p">[</span><span class="n">next_block</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">block_offset</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">):</span>
                                <span class="n">br_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">)</span>
                                <span class="n">new_br_offset</span> <span class="o">=</span> <span class="n">block_offset</span> <span class="o">-</span> <span class="n">br_offset</span> <span class="o">-</span> <span class="mi">5</span>
                                <span class="n">br_instr</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mh">0x38</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">new_br_offset</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span> <span class="o">+=</span> <span class="n">br_instr</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__compile_block</span><span class="p">(</span><span class="n">next_block</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span> <span class="o">+=</span> <span class="n">instr</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
    
    
<div class="viewcode-block" id="GraphRecompiler.recompile_graph">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.GraphRecompiler.recompile_graph">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">recompile_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">disasm_obj</span><span class="p">:</span> <span class="n">net_cil_disas</span><span class="o">.</span><span class="n">MethodDisassembler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__method_obj</span><span class="o">.</span><span class="n">disassemble_method</span><span class="p">()</span>
        <span class="n">header_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__method_obj</span><span class="o">.</span><span class="n">get_method_data</span><span class="p">()[:</span><span class="n">disasm_obj</span><span class="o">.</span><span class="n">header_size</span><span class="p">]</span>
        <span class="c1">#now we have the original header.  only thing we should need to change is the size.</span>
        <span class="c1">#compile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__compile_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__func_graph</span><span class="o">.</span><span class="n">get_root_block</span><span class="p">())</span>
        <span class="c1">#check the header to make sure we dont need to update size</span>
        <span class="n">header_ident</span> <span class="o">=</span> <span class="n">header_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">header_ident</span> <span class="o">&amp;</span> <span class="mi">7</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">code_size</span> <span class="o">=</span> <span class="n">header_ident</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="c1"># ok so if we right shift by 2 bits that gives us the method code meaning lower 2 bits are flags</span>
        
            <span class="k">if</span> <span class="n">code_size</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;tiny headers are not currently supported.&quot;</span><span class="p">)</span> <span class="c1"># TODO: add tiny header support.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header_bytes</span> <span class="o">=</span> <span class="n">header_bytes</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="nb">int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">header_bytes</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">header_bytes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span></div>

    
<div class="viewcode-block" id="GraphRecompiler.get_function_data">
<a class="viewcode-back" href="../../api/dotnetutils.net_graphing.html#dotnetutils.net_graphing.GraphRecompiler.get_function_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_function_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__function_data</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">dotnetutils</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">dotnetutils</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, IBM.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>